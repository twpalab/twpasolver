<!doctype html>
<html class="no-js" lang="en" data-content_root="">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Implementing New Models" href="../implementing_models.html" /><link rel="prev" title="3WM gain and TWPAnalysis" href="03_analysis.html" />

    <link rel="shortcut icon" href="../_static/favicon.ico"/><!-- Generated with Sphinx 6.2.1 and Furo 2023.09.10 -->
        <title>Advanced Coupled Mode Equations models - twpasolver · 0.0.1</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=369552022d0b975c8e74270ce6eabe0fb7978f24" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/style.css" />
    <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: #6400FF;
  --color-brand-secondary: #6400FF;
  --color-brand-content: #6400FF;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">twpasolver · 0.0.1</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../_static/twpalab_logo.png" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="../_static/twpalab_logo_dark.png" alt="Dark Logo"/>
  </div>
  
  <span class="sidebar-brand-text">twpasolver · 0.0.1</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../tutorials.html">Tutorials</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Tutorials</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="01_models.html">Network models</a></li>
<li class="toctree-l2"><a class="reference internal" href="02_twpas.html">Constructing twpas</a></li>
<li class="toctree-l2"><a class="reference internal" href="03_analysis.html">3WM gain and TWPAnalysis</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">Advanced Coupled Mode Equations models</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../implementing_models.html">Implementing New Models</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Api reference</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../api-reference/modules.html">twpasolver</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of twpasolver</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../api-reference/twpasolver.html">twpasolver package</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of twpasolver package</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../api-reference/twpasolver.models.html">twpasolver.models package</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of twpasolver.models package</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../api-reference/twpasolver.models.compose.html">twpasolver.models.compose module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api-reference/twpasolver.models.modelarray.html">twpasolver.models.modelarray module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api-reference/twpasolver.models.oneport.html">twpasolver.models.oneport module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api-reference/twpasolver.models.rf_functions.html">twpasolver.models.rf_functions module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api-reference/twpasolver.models.transmission_lines.html">twpasolver.models.transmission_lines module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api-reference/twpasolver.models.twoportarrays.html">twpasolver.models.twoportarrays module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../api-reference/twpasolver.models.twpa_cells.html">twpasolver.models.twpa_cells module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../api-reference/twpasolver.analysis.html">twpasolver.analysis module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api-reference/twpasolver.basemodel.html">twpasolver.basemodel module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api-reference/twpasolver.bonus_types.html">twpasolver.bonus_types module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api-reference/twpasolver.cmes.html">twpasolver.cmes module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api-reference/twpasolver.file_utils.html">twpasolver.file_utils module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api-reference/twpasolver.frequency.html">twpasolver.frequency module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api-reference/twpasolver.logger.html">twpasolver.logger module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api-reference/twpasolver.mathutils.html">twpasolver.mathutils module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api-reference/twpasolver.matrices_arrays.html">twpasolver.matrices_arrays module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api-reference/twpasolver.modes_rwa.html">twpasolver.modes_rwa module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api-reference/twpasolver.plotting.html">twpasolver.plotting module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../api-reference/twpasolver.twoport.html">twpasolver.twoport module</a></li>
</ul>
</li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="edit-this-page">
  <a class="muted-link" href="https://github.com/twpalab/twpasolver/edit/main/docs/source/notebooks/04_generalized_cmes.ipynb" title="Edit this page">
    <svg aria-hidden="true" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <path d="M4 20h4l10.5 -10.5a1.5 1.5 0 0 0 -4 -4l-10.5 10.5v4" />
      <line x1="13.5" y1="6.5" x2="17.5" y2="10.5" />
    </svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="Advanced-Coupled-Mode-Equations-models">
<h1>Advanced Coupled Mode Equations models<a class="headerlink" href="#Advanced-Coupled-Mode-Equations-models" title="Permalink to this heading">#</a></h1>
<p>This tutorial demonstrates how to use the advanced CMEs models to simulate the nonlinear response of a TWPA. We’ll explore extended mode systems that go beyond the basic pump-signal-idler configuration to include pump harmonics, frequency conversion processes, and higher-order effects.</p>
<section id="Overview">
<h2>Overview<a class="headerlink" href="#Overview" title="Permalink to this heading">#</a></h2>
<p>While the basic 3-wave mixing (3WM) model provides a good starting point for TWPA analysis, real devices exhibit more complex behavior due to:</p>
<ul class="simple">
<li><p><strong>Pump harmonics</strong>: 2nd, 3rd, and higher harmonics of the pump frequency</p></li>
<li><p><strong>Frequency conversion</strong>: Processes like pump + signal, pump + idler</p></li>
<li><p><strong>Signal/idler harmonics</strong>: Higher harmonics of signal and idler modes</p></li>
<li><p><strong>Device imperfections</strong>: Losses and reflections throughout the transmission line</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">twpasolver</span></code> library handles these effects automatically through its <code class="docutils literal notranslate"><span class="pre">ModeArray</span></code> system and advanced CME solvers.</p>
</section>
<section id="Initialize-TWPAnalysis">
<h2>Initialize TWPAnalysis<a class="headerlink" href="#Initialize-TWPAnalysis" title="Permalink to this heading">#</a></h2>
<p>First, let’s load a KITWPA model and plot its response. Since we are going to consider higher order processes, we will initialize TWPAnalysis with a larger frequency span to capture pump harmonics.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">twpasolver</span><span class="w"> </span><span class="kn">import</span> <span class="n">TWPAnalysis</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">twpasolver.logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">log</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">twpasolver.mathutils</span><span class="w"> </span><span class="kn">import</span> <span class="n">dBm_to_I</span>

<span class="n">log</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;font.size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">13.5</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;axes.axisbelow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">twpa_file</span> <span class="o">=</span> <span class="s2">&quot;model_cpw_dartwars_13nm_Lk8_5.json&quot;</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">TWPAnalysis</span><span class="p">(</span><span class="n">twpa</span><span class="o">=</span><span class="n">twpa_file</span><span class="p">,</span> <span class="n">f_arange</span><span class="o">=</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mf">0.5e-3</span><span class="p">))</span>
<span class="n">a</span><span class="o">.</span><span class="n">update_base_data</span><span class="p">()</span>

<span class="n">optimal_pump</span> <span class="o">=</span> <span class="mf">7.4755</span>
<span class="n">a</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;optimal_pump_freq&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimal_pump</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">plot_response</span><span class="p">(</span><span class="n">pump_freq</span><span class="o">=</span><span class="n">optimal_pump</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">optimal_pump</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">optimal_pump</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;r&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(-20.0, 1.0)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_04_generalized_cmes_1_1.png" src="../_images/notebooks_04_generalized_cmes_1_1.png" />
</div>
</div>
<p>Notice how we’ve extended the frequency range to 30 GHz to capture the 2nd and 3rd pump harmonics (marked with red dashed lines). The TWPA’s dispersive response means these harmonics will have different propagation constants and can participate in additional mixing processes.</p>
<section id="ModeArrays-and-ModeArrayFactory">
<h3>ModeArrays and ModeArrayFactory<a class="headerlink" href="#ModeArrays-and-ModeArrayFactory" title="Permalink to this heading">#</a></h3>
<p>Properly describing the nonlinear response of TWPAs requires going beyond the basic CMEs system that considers only pump, signal and idler. <code class="docutils literal notranslate"><span class="pre">twpasolver</span></code> uses <code class="docutils literal notranslate"><span class="pre">ModeArray</span></code> objects to automatically build and solve CMEs systems including an arbitrary number of physical modes connected by frequency relationships.</p>
<p>A <code class="docutils literal notranslate"><span class="pre">ModeArray</span></code> has several key features:</p>
<ul class="simple">
<li><p><strong>Dependency graph management</strong>: Organizes mode relations and identifies independent modes</p></li>
<li><p><strong>Automatic parameter interpolation</strong>: Extrapolates physical properties (frequency, wavenumber, losses) according to the relations</p></li>
<li><p><strong>RWA term selection</strong>: Automatically selects the 3WM and 4WM terms that satisfy the Rotating Wave Approximation when solving the CMEs</p></li>
<li><p><strong>Symbolic frequency propagation</strong>: Updates all related mode frequencies in O(n) time using pre-computed expressions</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">ModeArrayFactory</span></code> helps set up custom mode arrays or create standard extended mode collections.</p>
<p>Here’s how to set up a ModeArray with custom defined modes and relations:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">twpasolver.modes_rwa</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModeArrayFactory</span>

<span class="n">mode_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;p2&quot;</span><span class="p">]</span>
<span class="n">mode_relations</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;p-s&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;p2&quot;</span><span class="p">,</span> <span class="s2">&quot;p+p&quot;</span><span class="p">]]</span>
<span class="n">mode_array_p2</span> <span class="o">=</span> <span class="n">ModeArrayFactory</span><span class="o">.</span><span class="n">create_custom</span><span class="p">(</span>
    <span class="n">a</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
    <span class="n">mode_labels</span><span class="o">=</span><span class="n">mode_labels</span><span class="p">,</span>
    <span class="n">mode_directions</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
    <span class="n">relations</span><span class="o">=</span><span class="n">mode_relations</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">mode_array_p2</span><span class="o">.</span><span class="n">plot_mode_relations</span><span class="p">(</span><span class="n">layout</span><span class="o">=</span><span class="s2">&quot;circular&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_04_generalized_cmes_3_0.png" src="../_images/notebooks_04_generalized_cmes_3_0.png" />
</div>
</div>
<p>The graph shows the mode relationships where:</p>
<ul class="simple">
<li><p><strong>Green nodes</strong>: Independent modes (pump <code class="docutils literal notranslate"><span class="pre">p</span></code> and signal <code class="docutils literal notranslate"><span class="pre">s</span></code>)</p></li>
<li><p><strong>Blue nodes</strong>: Dependent modes (idler <code class="docutils literal notranslate"><span class="pre">i</span></code> and 2nd pump harmonic <code class="docutils literal notranslate"><span class="pre">p2</span></code>)</p></li>
<li><p><strong>Blue arrows</strong>: Positive frequency contributions</p></li>
<li><p><strong>Red dashed arrows</strong>: Negative frequency contributions</p></li>
</ul>
<p>The symbolic expressions on the right show how each mode’s frequency depends on the independent modes.</p>
<p>For more realistic simulations, you should consider pump harmonics, frequency conversion processes and signal/idler harmonics. The <code class="docutils literal notranslate"><span class="pre">create_extended_3wm</span></code> method creates a comprehensive set of modes automatically:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mode_array</span> <span class="o">=</span> <span class="n">ModeArrayFactory</span><span class="o">.</span><span class="n">create_extended_3wm</span><span class="p">(</span>
    <span class="n">a</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">n_pump_harmonics</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_frequency_conversion</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_signal_harmonics</span><span class="o">=</span><span class="mi">1</span>
<span class="p">)</span>
<span class="n">mode_array</span><span class="o">.</span><span class="n">plot_mode_relations</span><span class="p">(</span><span class="n">show_frequencies</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">a</span><span class="o">.</span><span class="n">add_mode_array</span><span class="p">(</span><span class="s2">&quot;gain_extended&quot;</span><span class="p">,</span> <span class="n">mode_array</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_04_generalized_cmes_5_0.png" src="../_images/notebooks_04_generalized_cmes_5_0.png" />
</div>
</div>
<p>This extended mode array includes:</p>
<ul class="simple">
<li><p><strong>Pump harmonics</strong>: <code class="docutils literal notranslate"><span class="pre">p</span></code>, <code class="docutils literal notranslate"><span class="pre">p2</span></code>, <code class="docutils literal notranslate"><span class="pre">p3</span></code> (fundamental, 2nd and 3rd harmonic)</p></li>
<li><p><strong>Basic 3WM</strong>: <code class="docutils literal notranslate"><span class="pre">s</span></code>, <code class="docutils literal notranslate"><span class="pre">i</span></code> (signal and idler)</p></li>
<li><p><strong>Frequency conversion</strong>: <code class="docutils literal notranslate"><span class="pre">ps</span></code> (p+s), <code class="docutils literal notranslate"><span class="pre">pi</span></code> (p+i), and higher order processes generated by the pump harmonics</p></li>
<li><p><strong>Signal harmonics</strong>: <code class="docutils literal notranslate"><span class="pre">s2</span></code>, <code class="docutils literal notranslate"><span class="pre">i2</span></code> (first harmonics of signal and idler)</p></li>
</ul>
<p>The hierarchical layout shows the dependency relationships, with independent modes at the top and increasingly complex derived modes below them.</p>
</section>
<section id="Gain-comparison-with-different-models">
<h3>Gain comparison with different models<a class="headerlink" href="#Gain-comparison-with-different-models" title="Permalink to this heading">#</a></h3>
<p>You can use the <code class="docutils literal notranslate"><span class="pre">model</span></code> parameter of the <code class="docutils literal notranslate"><span class="pre">gain</span></code> analysis function to specify which CME model to use. The library provides four models with increasing complexity:</p>
<ul class="simple">
<li><p><strong>minimal_3wm</strong>: Basic pump-signal-idler model (fastest)</p></li>
<li><p><strong>general_ideal</strong>: Extended modes without losses or reflections</p></li>
<li><p><strong>general_loss_only</strong>: Extended modes with losses but no reflections</p></li>
<li><p><strong>general</strong>: Full model with losses and reflections (most accurate but slow)</p></li>
</ul>
<p>Once compiled, even simulations with large numbers of modes are quite fast thanks to Numba acceleration:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s_arange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mf">6.5</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>

<span class="n">res_gain_base</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">gain</span><span class="p">(</span><span class="n">signal_freqs</span><span class="o">=</span><span class="n">s_arange</span><span class="p">,</span> <span class="n">Is0</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">pump</span><span class="o">=</span><span class="n">optimal_pump</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">plot_gain</span><span class="p">()</span>
<span class="n">res_gain_extended</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">gain</span><span class="p">(</span>
    <span class="n">signal_freqs</span><span class="o">=</span><span class="n">s_arange</span><span class="p">,</span>
    <span class="n">Is0</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
    <span class="n">pump</span><span class="o">=</span><span class="n">optimal_pump</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;general_ideal&quot;</span><span class="p">,</span>
    <span class="n">mode_array_config</span><span class="o">=</span><span class="s2">&quot;gain_extended&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">res_gain_with_loss</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">gain</span><span class="p">(</span>
    <span class="n">signal_freqs</span><span class="o">=</span><span class="n">s_arange</span><span class="p">,</span>
    <span class="n">Is0</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
    <span class="n">pump</span><span class="o">=</span><span class="n">optimal_pump</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;general_loss_only&quot;</span><span class="p">,</span>
    <span class="n">mode_array_config</span><span class="o">=</span><span class="s2">&quot;gain_extended&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s_arange</span><span class="p">,</span> <span class="n">res_gain_extended</span><span class="p">[</span><span class="s2">&quot;gain_db&quot;</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s_arange</span><span class="p">,</span> <span class="n">res_gain_with_loss</span><span class="p">[</span><span class="s2">&quot;gain_db&quot;</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span>
    <span class="p">[</span><span class="s2">&quot;basic&quot;</span><span class="p">,</span> <span class="s2">&quot;extended, ideal&quot;</span><span class="p">,</span> <span class="s2">&quot;extended, with loss&quot;</span><span class="p">],</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f48e694d960&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_04_generalized_cmes_7_1.png" src="../_images/notebooks_04_generalized_cmes_7_1.png" />
</div>
</div>
<p>The most realistic model takes into account both losses and reflections in the device, but requires more computation time (typically ~10x the ideal models):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_gain_with_reflections_wide</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">gain</span><span class="p">(</span>
    <span class="n">signal_freqs</span><span class="o">=</span><span class="n">s_arange</span><span class="p">,</span>
    <span class="n">Is0</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
    <span class="n">pump</span><span class="o">=</span><span class="n">optimal_pump</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;general&quot;</span><span class="p">,</span>
    <span class="n">mode_array_config</span><span class="o">=</span><span class="s2">&quot;gain_extended&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">plot_gain</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_04_generalized_cmes_9_0.png" src="../_images/notebooks_04_generalized_cmes_9_0.png" />
</div>
</div>
<p>The full model including reflections can reveal fine structure in the gain profile that other models miss. For critical applications requiring quantitative agreement with experiment, this model provides the highest accuracy.</p>
<p>Let’s zoom in on a narrower frequency range to see the gain ripples:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s_arange</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">)</span>
<span class="n">res_gain_with_reflections_narrow</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">gain</span><span class="p">(</span>
    <span class="n">signal_freqs</span><span class="o">=</span><span class="n">s_arange</span><span class="p">,</span>
    <span class="n">Is0</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
    <span class="n">pump</span><span class="o">=</span><span class="n">optimal_pump</span><span class="p">,</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;general&quot;</span><span class="p">,</span>
    <span class="n">mode_array_config</span><span class="o">=</span><span class="s2">&quot;gain_extended&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">plot_gain</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_04_generalized_cmes_11_0.png" src="../_images/notebooks_04_generalized_cmes_11_0.png" />
</div>
</div>
</section>
<section id="Mode-Current-Analysis">
<h3>Mode Current Analysis<a class="headerlink" href="#Mode-Current-Analysis" title="Permalink to this heading">#</a></h3>
<p>Another useful feature of <code class="docutils literal notranslate"><span class="pre">TWPAnalysis</span></code> is the ability to plot the average currents for each mode as a function of position along the transmission line. This helps identify which processes are most relevant to the simulated response and understand the energy flow between different modes:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="o">.</span><span class="n">plot_mode_currents</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;Axes: title={&#39;center&#39;: &#39;Mean Mode Currents vs Cell Number\nPump Frequency: 7.4755 GHz&#39;}, xlabel=&#39;Cell Number&#39;, ylabel=&#39;Current (dBm)&#39;&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/notebooks_04_generalized_cmes_13_1.png" src="../_images/notebooks_04_generalized_cmes_13_1.png" />
</div>
</div>
<p>The mode currents plot can show:</p>
<ul class="simple">
<li><p><strong>Pump depletion</strong>: The pump current typically decreases along the line as energy is transferred to signal and idler or is dissipated in a lossy device</p></li>
<li><p><strong>Signal amplification</strong>: The signal current grows exponentially in the gain region</p></li>
<li><p><strong>Idler generation</strong>: The idler current increases as the parametric process generates idler photons</p></li>
<li><p><strong>Harmonic contributions</strong>: Higher-order modes show their relative importance</p></li>
</ul>
<p>Modes with negligible current levels throughout the device can often be safely excluded from the analysis to improve computational efficiency.</p>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="../implementing_models.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Implementing New Models</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="03_analysis.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">3WM gain and TWPAnalysis</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, twpalab
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/twpalab/twpasolver" aria-label="GitHub">
                    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                    </svg>
                </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Advanced Coupled Mode Equations models</a><ul>
<li><a class="reference internal" href="#Overview">Overview</a></li>
<li><a class="reference internal" href="#Initialize-TWPAnalysis">Initialize TWPAnalysis</a><ul>
<li><a class="reference internal" href="#ModeArrays-and-ModeArrayFactory">ModeArrays and ModeArrayFactory</a></li>
<li><a class="reference internal" href="#Gain-comparison-with-different-models">Gain comparison with different models</a></li>
<li><a class="reference internal" href="#Mode-Current-Analysis">Mode Current Analysis</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    </body>
</html>