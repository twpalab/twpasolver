<!doctype html>
<html class="no-js" lang="en" data-content_root="">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html" /><link rel="search" title="Search" href="../../search.html" />

    <link rel="shortcut icon" href="../../_static/favicon.ico"/><!-- Generated with Sphinx 6.2.1 and Furo 2023.09.10 -->
        <title>twpasolver.modes_rwa - twpasolver · 0.0.1</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?digest=369552022d0b975c8e74270ce6eabe0fb7978f24" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/autodoc_pydantic.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/style.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: #6400FF;
  --color-brand-secondary: #6400FF;
  --color-brand-content: #6400FF;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">twpasolver · 0.0.1</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../../_static/twpalab_logo.png" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="../../_static/twpalab_logo_dark.png" alt="Dark Logo"/>
  </div>
  
  <span class="sidebar-brand-text">twpasolver · 0.0.1</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../tutorials.html">Tutorials</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Tutorials</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/01_models.html">Network models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/02_twpas.html">Constructing twpas</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/03_analysis.html">3WM gain and TWPAnalysis</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../notebooks/04_generalized_cmes.html">Advanced Coupled Mode Equations models</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../implementing_models.html">Implementing New Models</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Api reference</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../api-reference/modules.html">twpasolver</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of twpasolver</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../api-reference/twpasolver.html">twpasolver package</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of twpasolver package</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../api-reference/twpasolver.models.html">twpasolver.models package</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of twpasolver.models package</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../api-reference/twpasolver.models.compose.html">twpasolver.models.compose module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api-reference/twpasolver.models.modelarray.html">twpasolver.models.modelarray module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api-reference/twpasolver.models.oneport.html">twpasolver.models.oneport module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api-reference/twpasolver.models.rf_functions.html">twpasolver.models.rf_functions module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api-reference/twpasolver.models.transmission_lines.html">twpasolver.models.transmission_lines module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api-reference/twpasolver.models.twoportarrays.html">twpasolver.models.twoportarrays module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../api-reference/twpasolver.models.twpa_cells.html">twpasolver.models.twpa_cells module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../api-reference/twpasolver.analysis.html">twpasolver.analysis module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api-reference/twpasolver.basemodel.html">twpasolver.basemodel module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api-reference/twpasolver.bonus_types.html">twpasolver.bonus_types module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api-reference/twpasolver.cmes.html">twpasolver.cmes module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api-reference/twpasolver.file_utils.html">twpasolver.file_utils module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api-reference/twpasolver.frequency.html">twpasolver.frequency module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api-reference/twpasolver.logger.html">twpasolver.logger module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api-reference/twpasolver.mathutils.html">twpasolver.mathutils module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api-reference/twpasolver.matrices_arrays.html">twpasolver.matrices_arrays module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api-reference/twpasolver.modes_rwa.html">twpasolver.modes_rwa module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api-reference/twpasolver.plotting.html">twpasolver.plotting module</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../api-reference/twpasolver.twoport.html">twpasolver.twoport module</a></li>
</ul>
</li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <h1>Source code for twpasolver.modes_rwa</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">``modes_rwa`` module.</span>

<span class="sd">Mode Management and Rotating Wave Approximation Analysis</span>
<span class="sd">========================================================</span>

<span class="sd">Tools for managing complex mode relationships in TWPA analysis, enabling</span>
<span class="sd">simulation of extended coupled mode equation (CME) systems with arbitrary</span>
<span class="sd">numbers of modes beyond basic pump-signal-idler configuration.</span>

<span class="sd">Key Components</span>
<span class="sd">--------------</span>

<span class="sd">**ModeArray**: Organizes related modes with automatic frequency propagation,</span>
<span class="sd">parameter interpolation, and dependency graph management.</span>

<span class="sd">**RWAAnalyzer**: Identifies valid 3-wave and 4-wave mixing terms that satisfy</span>
<span class="sd">the Rotating Wave Approximation for any given set of mode relationships.</span>

<span class="sd">**ModeArrayFactory**: Factory methods for creating standard and custom mode</span>
<span class="sd">configurations including pump harmonics, frequency conversion terms, and harmonics.</span>

<span class="sd">**ParameterInterpolator**: Interpolation of mode parameters (kappa, gamma, alpha)</span>
<span class="sd">from base TWPA circuit data across frequency ranges.</span>

<span class="sd">Capabilities</span>
<span class="sd">------------</span>

<span class="sd">**RWA Term Selection**:</span>
<span class="sd">    - Automatic discovery of valid 3WM and 4WM mixing processes</span>
<span class="sd">    - Coefficient calculation including factorial corrections for repeated modes</span>
<span class="sd">    - Caching of RWA terms for performance</span>

<span class="sd">**Mode Relationships**:</span>
<span class="sd">    - Support for arbitrary frequency relationships between modes</span>
<span class="sd">    - Forward and backward propagating modes</span>
<span class="sd">    - Pump harmonics (p, p2, p3, ...)</span>
<span class="sd">    - Frequency conversion terms (p+s, p+i, ...)</span>
<span class="sd">    - Signal/idler harmonics (s2, i2, ...)</span>

<span class="sd">**Symbolic Frequency Propagation**:</span>
<span class="sd">    - O(n) frequency updates using pre-computed symbolic expressions</span>
<span class="sd">    - Automatic identification of independent vs. dependent modes</span>
<span class="sd">    - Topological sorting of mode dependencies</span>
<span class="sd">    - Visualization of the mode relations with a graph</span>

<span class="sd">**Parameter Management**:</span>
<span class="sd">    - Easy interpolation of mode parameters from base circuit data</span>
<span class="sd">    - Automatic handling of mode directions for wavenumber calculation</span>

<span class="sd">Examples</span>
<span class="sd">--------</span>
<span class="sd">See Tutorial 4 (:ref:`tutorials`) for complete examples covering:</span>

<span class="sd">- Basic 3WM mode array creation and visualization</span>
<span class="sd">- Extended mode arrays with pump harmonics and frequency conversion</span>
<span class="sd">- Custom mode configurations for specific processes</span>
<span class="sd">- RWA term analysis and CME integration</span>

<span class="sd">The tutorial demonstrates the progression from simple mode relationships to</span>
<span class="sd">complex multi-mode systems used in realistic TWPA simulations.</span>

<span class="sd">Performance Notes</span>
<span class="sd">-----------------</span>
<span class="sd">- Symbolic frequency propagation enables O(n) scaling, useful when iterating over arrays.</span>
<span class="sd">- RWA term caching eliminates redundant calculations during CME solving</span>
<span class="sd">- Numba-compatible data structures for integration with fast CME solvers</span>
<span class="sd">- Efficient interpolation supports faster parameter sweeps</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">it</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">deque</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">copy</span><span class="w"> </span><span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">factorial</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.patches</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">mpatches</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.interpolate</span><span class="w"> </span><span class="kn">import</span> <span class="n">interp1d</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sympy</span><span class="w"> </span><span class="kn">import</span> <span class="n">symbols</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">twpasolver.logger</span><span class="w"> </span><span class="kn">import</span> <span class="n">log</span>


<div class="viewcode-block" id="ParameterInterpolator"><a class="viewcode-back" href="../../api-reference/twpasolver.modes_rwa.html#twpasolver.modes_rwa.ParameterInterpolator">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">ParameterInterpolator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interpolates kappa, gamma, and alpha values based on frequency.</span>

<span class="sd">    Always returns real kappa and alpha, complex gamma.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">frequencies</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">kappas</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">gammas</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">alphas</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">kind</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cubic&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize interpolators for kappa, gamma, and alpha.</span>

<span class="sd">        Args:</span>
<span class="sd">            frequencies: Array of frequency points</span>
<span class="sd">            kappas: Array of coupling coefficients (real)</span>
<span class="sd">            gammas: Array of reflection coefficients (complex)</span>
<span class="sd">            alphas: Array of attenuation coefficients (real)</span>
<span class="sd">            kind: Interpolation method (&#39;linear&#39;, &#39;cubic&#39;, etc.)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate input arrays</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">frequencies</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">kappas</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">gammas</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">alphas</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Frequencies, kappas, gammas, and alphas must have the same length&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frequencies</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Need at least 2 points for interpolation&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">orig_freqs</span> <span class="o">=</span> <span class="n">frequencies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_kappas</span> <span class="o">=</span> <span class="n">kappas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_gammas</span> <span class="o">=</span> <span class="n">gammas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orig_alphas</span> <span class="o">=</span> <span class="n">alphas</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">frequencies</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">frequencies</span><span class="p">)</span>

        <span class="c1"># For kappa interpolation (real only)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kappa_interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
            <span class="n">frequencies</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">kappas</span><span class="p">),</span>
            <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
            <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">fill_value</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">kappas</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">kappas</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])),</span>
        <span class="p">)</span>

        <span class="c1"># For gamma interpolation (complex)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">iscomplexobj</span><span class="p">(</span><span class="n">gammas</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gamma_real</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
                <span class="n">frequencies</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">gammas</span><span class="p">),</span>
                <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
                <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">fill_value</span><span class="o">=</span><span class="p">(</span><span class="n">gammas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">gammas</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gamma_imag</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
                <span class="n">frequencies</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">gammas</span><span class="p">),</span>
                <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
                <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">fill_value</span><span class="o">=</span><span class="p">(</span><span class="n">gammas</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span><span class="p">,</span> <span class="n">gammas</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imag</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gamma_real</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
                <span class="n">frequencies</span><span class="p">,</span>
                <span class="n">gammas</span><span class="p">,</span>
                <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
                <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">fill_value</span><span class="o">=</span><span class="p">(</span><span class="n">gammas</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gammas</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">gamma_imag</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># For alpha interpolation (real only)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_interp</span> <span class="o">=</span> <span class="n">interp1d</span><span class="p">(</span>
            <span class="n">frequencies</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">alphas</span><span class="p">),</span>
            <span class="n">kind</span><span class="o">=</span><span class="n">kind</span><span class="p">,</span>
            <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">fill_value</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">alphas</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">alphas</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])),</span>
        <span class="p">)</span>

<div class="viewcode-block" id="ParameterInterpolator.get_parameters"><a class="viewcode-back" href="../../api-reference/twpasolver.modes_rwa.html#twpasolver.modes_rwa.ParameterInterpolator.get_parameters">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_parameters</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span>
        <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Union</span><span class="p">[</span><span class="nb">complex</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
    <span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get interpolated kappa, gamma, and alpha for a given frequency or array of frequencies.</span>

<span class="sd">        Args:</span>
<span class="sd">            frequency: Frequency point(s) for interpolation, can be a single value or array</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of (kappa, gamma, alpha) at the requested frequency/frequencies</span>
<span class="sd">            kappa and alpha are real, gamma is complex</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if we&#39;re processing a single value or array</span>
        <span class="n">is_array</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span>

        <span class="c1"># Handle out-of-range warning</span>
        <span class="k">if</span> <span class="n">is_array</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">((</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq_min</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">frequency</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq_max</span><span class="p">)):</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Warning: Some frequencies are outside the interpolation range &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_min</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_max</span><span class="si">}</span><span class="s2">]. Using endpoint values.&quot;</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">frequency</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq_min</span> <span class="ow">or</span> <span class="n">frequency</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq_max</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Warning: Frequency </span><span class="si">{</span><span class="n">frequency</span><span class="si">}</span><span class="s2"> is outside the interpolation range &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_min</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_max</span><span class="si">}</span><span class="s2">]. Using endpoint values.&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Interpolate kappa (real only)</span>
        <span class="n">kappa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kappa_interp</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>

        <span class="c1"># Interpolate gamma (complex)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma_imag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gamma_real</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma_real</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>
            <span class="n">gamma_imag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma_imag</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>
            <span class="n">gamma</span> <span class="o">=</span> <span class="n">gamma_real</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">gamma_imag</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma_real</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>

        <span class="c1"># Interpolate alpha (real only)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_interp</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">alpha</span></div></div>


<div class="viewcode-block" id="Mode"><a class="viewcode-back" href="../../api-reference/twpasolver.modes_rwa.html#twpasolver.modes_rwa.Mode">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Mode</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a single mode with its physical properties.</span>

<span class="sd">    Args:</span>
<span class="sd">        label: Mode identifier (e.g., &#39;p&#39; for pump)</span>
<span class="sd">        frequency: Mode frequency</span>
<span class="sd">        direction: 1 for forward, -1 for backward</span>
<span class="sd">        gamma: Reflection coefficient</span>
<span class="sd">        k: Wavenumber (calculated from frequency)</span>
<span class="sd">        alpha: Attenuation constant</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">label</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">direction</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># 1 for forward, -1 for backward</span>
    <span class="n">frequency</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">k</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">gamma</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">complex</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize derived quantities and validate inputs.&quot;&quot;&quot;</span>
        <span class="c1"># Ensure direction is ±1</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Direction must be either 1 (forward) or -1 (backward)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compare modes based on their physical properties.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Mode</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">frequency</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">direction</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">gamma</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">k</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">alpha</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get hash based on immutable properties.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">hash</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get string representation showing direction and label.&quot;&quot;&quot;</span>
        <span class="n">direction_str</span> <span class="o">=</span> <span class="s2">&quot;→&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;←&quot;</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">direction_str</span><span class="si">}{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get representation of class.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;Mode(&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">label</span><span class="si">}</span><span class="s1">&quot;, freq=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="si">}</span><span class="s1">, &#39;</span>
            <span class="sa">f</span><span class="s2">&quot;dir=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">direction</span><span class="si">}</span><span class="s2">, gamma=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="si">}</span><span class="s2">, k=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="si">}</span><span class="s2">, alpha=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="RWAAnalyzer"><a class="viewcode-back" href="../../api-reference/twpasolver.modes_rwa.html#twpasolver.modes_rwa.RWAAnalyzer">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">RWAAnalyzer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Analyzer class for a set of coupled modes.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">modes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">relations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the RWA analyzer with modes and their relations.</span>

<span class="sd">        Args:</span>
<span class="sd">            modes: List of mode names (e.g., [&quot;p&quot;, &quot;s&quot;, &quot;i&quot;, &quot;c&quot;, &quot;d&quot;, &quot;u&quot;, &quot;c2&quot;])</span>
<span class="sd">            relations: List of relations [result, expression] where expression can be</span>
<span class="sd">                      any combination of terms with + and - (e.g., [&quot;c2&quot;, &quot;c+c&quot;])</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modes</span> <span class="o">=</span> <span class="n">modes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modes_ext_str</span> <span class="o">=</span> <span class="n">modes</span> <span class="o">+</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;-</span><span class="si">{</span><span class="n">m</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">modes</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modes_symbolic</span> <span class="o">=</span> <span class="p">[</span><span class="n">symbols</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">modes</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modes_extended</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes_symbolic</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes_symbolic</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mode_to_idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">mode</span><span class="p">:</span> <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">mode</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">modes</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_relations</span> <span class="o">=</span> <span class="n">relations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relations_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_relations_to_indices</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modes_subs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_substitutions</span><span class="p">()</span>

        <span class="c1"># Cache for RWA terms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rwa_terms_cache</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">relations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Getter for mode relations.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_relations</span>

<div class="viewcode-block" id="RWAAnalyzer.update_relations"><a class="viewcode-back" href="../../api-reference/twpasolver.modes_rwa.html#twpasolver.modes_rwa.RWAAnalyzer.update_relations">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_relations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">relations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update mode relations.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_relations</span> <span class="o">=</span> <span class="n">relations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relations_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_relations_to_indices</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modes_subs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_substitutions</span><span class="p">()</span>
        <span class="c1"># Clear cache when relations are updated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rwa_terms_cache</span> <span class="o">=</span> <span class="p">{}</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parse an expression string into a list of indices with proper signs.</span>

<span class="sd">        Args:</span>
<span class="sd">            expr: String expression like &quot;p+s-i&quot;</span>

<span class="sd">        Returns:</span>
<span class="sd">            Tuple of indices with signs indicating conjugation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">):</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span> <span class="o">+</span> <span class="n">expr</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">signs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_term</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">expr</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">char</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">current_term</span><span class="p">:</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_to_idx</span><span class="p">[</span><span class="n">current_term</span><span class="p">]</span>
                    <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
                    <span class="n">signs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sign</span><span class="p">)</span>
                <span class="n">current_term</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">char</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">current_term</span> <span class="o">+=</span> <span class="n">char</span>

        <span class="k">if</span> <span class="n">current_term</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_to_idx</span><span class="p">[</span><span class="n">current_term</span><span class="p">]</span>
            <span class="n">indices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="n">signs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sign</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">indices</span><span class="p">),</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">signs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_convert_relations_to_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert string relations to index-based relations.&quot;&quot;&quot;</span>
        <span class="n">index_relations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">result</span><span class="p">,</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">relations</span><span class="p">:</span>
            <span class="n">result_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_to_idx</span><span class="p">[</span><span class="n">result</span><span class="p">]</span>
            <span class="n">input_indices</span><span class="p">,</span> <span class="n">input_signs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_expression</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
            <span class="n">index_relations</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">result_idx</span><span class="p">,</span> <span class="n">input_indices</span><span class="p">,</span> <span class="n">input_signs</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">index_relations</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_substitutions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute all mode substitutions based on the relations.&quot;&quot;&quot;</span>
        <span class="n">apply</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">modes_subs</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes_symbolic</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">apply</span><span class="p">:</span>
            <span class="n">modes_subs_old</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">modes_subs</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">output</span><span class="p">,</span> <span class="n">input_idxs</span><span class="p">,</span> <span class="n">input_signs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">relations_idx</span><span class="p">:</span>
                <span class="n">subs_rel</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">input_signs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">modes_subs</span><span class="p">[</span><span class="nb">abs</span><span class="p">(</span><span class="n">rel_idx</span><span class="p">)]</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rel_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">input_idxs</span><span class="p">)</span>
                    <span class="p">]</span>
                <span class="p">)</span>
                <span class="n">modes_subs</span><span class="p">[</span><span class="n">output</span><span class="p">]</span> <span class="o">=</span> <span class="n">modes_subs</span><span class="p">[</span><span class="n">output</span><span class="p">]</span><span class="o">.</span><span class="n">subs</span><span class="p">(</span>
                    <span class="n">modes_subs</span><span class="p">[</span><span class="n">output</span><span class="p">],</span> <span class="n">subs_rel</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">m</span> <span class="o">==</span> <span class="n">modes_subs_old</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">modes_subs</span><span class="p">)]):</span>
                    <span class="n">apply</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">modes_subs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_coefficient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">terms</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate coefficient based on term repetitions.&quot;&quot;&quot;</span>
        <span class="n">coeff</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">terms</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">terms</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">repetitions</span> <span class="ow">in</span> <span class="n">Counter</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">coeff</span> <span class="o">=</span> <span class="n">coeff</span> <span class="o">/</span> <span class="n">factorial</span><span class="p">(</span><span class="n">repetitions</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">coeff</span>

<div class="viewcode-block" id="RWAAnalyzer.find_rwa_terms"><a class="viewcode-back" href="../../api-reference/twpasolver.modes_rwa.html#twpasolver.modes_rwa.RWAAnalyzer.find_rwa_terms">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">find_rwa_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">power</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Find all valid RWA terms of given power.</span>

<span class="sd">        Args:</span>
<span class="sd">            power: Order of the interaction (default: 3 for three-wave mixing)</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of tuples (mode_idx, combination, mode_name, rhs_terms, coefficient)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Check if cached result exists</span>
        <span class="k">if</span> <span class="n">power</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rwa_terms_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rwa_terms_cache</span><span class="p">[</span><span class="n">power</span><span class="p">]</span>

        <span class="n">modes_subs_extended</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes_subs</span> <span class="o">+</span> <span class="p">[</span><span class="o">-</span><span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes_subs</span><span class="p">]</span>
        <span class="n">rwa_terms</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">comb</span> <span class="ow">in</span> <span class="n">it</span><span class="o">.</span><span class="n">combinations_with_replacement</span><span class="p">(</span>
            <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes_extended</span><span class="p">)),</span> <span class="n">power</span>
        <span class="p">):</span>
            <span class="n">terms</span> <span class="o">=</span> <span class="p">[</span><span class="n">modes_subs_extended</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">comb</span><span class="p">]</span>
            <span class="n">sum_terms</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">mode</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes_subs</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">sum_terms</span> <span class="o">==</span> <span class="n">mode</span><span class="p">:</span>
                    <span class="n">rhs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">modes_ext_str</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">comb</span><span class="p">]</span>
                    <span class="n">coeff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_coefficient</span><span class="p">(</span><span class="n">rhs</span><span class="p">)</span>
                    <span class="n">rwa_terms</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">j</span><span class="p">,</span> <span class="n">comb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">rhs</span><span class="p">,</span> <span class="n">coeff</span><span class="p">))</span>

        <span class="n">result</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">rwa_terms</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># Cache the result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rwa_terms_cache</span><span class="p">[</span><span class="n">power</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="RWAAnalyzer.print_rwa_terms"><a class="viewcode-back" href="../../api-reference/twpasolver.modes_rwa.html#twpasolver.modes_rwa.RWAAnalyzer.print_rwa_terms">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">print_rwa_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">terms</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pretty print the RWA terms with their coefficients.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">:</span>
            <span class="n">mode_name</span> <span class="o">=</span> <span class="n">term</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">rhs_terms</span> <span class="o">=</span> <span class="n">term</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">coeff</span> <span class="o">=</span> <span class="n">term</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mode_name</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">rhs_terms</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">coeff</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Total matches: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ModeArray"><a class="viewcode-back" href="../../api-reference/twpasolver.modes_rwa.html#twpasolver.modes_rwa.ModeArray">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">ModeArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Class representing a list of modes and frequency relations between them.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">modes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Mode</span><span class="p">],</span>
        <span class="n">relations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
        <span class="n">interpolator</span><span class="p">:</span> <span class="n">ParameterInterpolator</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize mode array with modes, relations and interpolator.</span>

<span class="sd">        Args:</span>
<span class="sd">            modes: List of Mode objects</span>
<span class="sd">            relations: List of [result, expression] pairs for mode relationships</span>
<span class="sd">            interpolator: ParameterInterpolator instance for getting mode parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modes</span> <span class="o">=</span> <span class="p">{</span><span class="n">mode</span><span class="o">.</span><span class="n">label</span><span class="p">:</span> <span class="n">mode</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">modes</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relations</span> <span class="o">=</span> <span class="n">relations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpolator</span> <span class="o">=</span> <span class="n">interpolator</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span> <span class="o">=</span> <span class="n">RWAAnalyzer</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">relations</span><span class="p">)</span>

        <span class="c1"># Build symbolic expressions for efficient frequency propagation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_symbolic_expressions</span><span class="p">()</span>

        <span class="c1"># Cache for computed mixing coefficients</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rwa_terms_3wm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rwa_terms_4wm</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Validate initial state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_modes</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_expression_for_propagation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse expression into list of (mode, coefficient) pairs for frequency propagation.&quot;&quot;&quot;</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span><span class="o">.</span><span class="n">startswith</span><span class="p">((</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)):</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="s2">&quot;+&quot;</span> <span class="o">+</span> <span class="n">expr</span>

        <span class="n">terms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">current_term</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">expr</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">char</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">current_term</span><span class="p">:</span>
                    <span class="n">terms</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">current_term</span><span class="p">,</span> <span class="n">sign</span><span class="p">))</span>
                <span class="n">current_term</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">char</span> <span class="o">==</span> <span class="s2">&quot;+&quot;</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">current_term</span> <span class="o">+=</span> <span class="n">char</span>

        <span class="k">if</span> <span class="n">current_term</span><span class="p">:</span>
            <span class="n">terms</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">current_term</span><span class="p">,</span> <span class="n">sign</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">terms</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_dependency_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build dependency graph for relation analysis.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reverse_deps</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">result</span><span class="p">,</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">relations</span><span class="p">:</span>
            <span class="n">terms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_expression_for_propagation</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reverse_deps</span><span class="p">[</span><span class="n">result</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_topological_sort</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform topological sort of dependencies.&quot;&quot;&quot;</span>
        <span class="n">in_degree</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Calculate in-degrees</span>
        <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">in_degree</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reverse_deps</span><span class="p">[</span><span class="n">mode</span><span class="p">])</span>

        <span class="c1"># Start with modes that have no dependencies</span>
        <span class="n">queue</span> <span class="o">=</span> <span class="n">deque</span><span class="p">([</span><span class="n">mode</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">in_degree</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">while</span> <span class="n">queue</span><span class="p">:</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">popleft</span><span class="p">()</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>

            <span class="c1"># Update in-degrees of dependent modes</span>
            <span class="k">for</span> <span class="n">dependent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="p">[</span><span class="n">current</span><span class="p">]:</span>
                <span class="n">in_degree</span><span class="p">[</span><span class="n">dependent</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">in_degree</span><span class="p">[</span><span class="n">dependent</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">queue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dependent</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_symbolic_expressions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build symbolic expressions for each mode in terms of independent modes.</span>

<span class="sd">        This enables O(n) frequency propagation instead of iterative solving.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Build dependency graph</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_build_dependency_graph</span><span class="p">()</span>

        <span class="c1"># Find independent modes (those not defined by relations)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">independent_modes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">result</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">relations</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">independent_modes</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="c1"># Initialize symbolic expressions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">symbolic_expressions</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Independent modes have simple expressions</span>
        <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">independent_modes</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">symbolic_expressions</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">mode</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">}</span>

        <span class="c1"># Build expressions for dependent modes using topological order</span>
        <span class="n">topo_order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topological_sort</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">topo_order</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbolic_expressions</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># Already processed (independent mode)</span>

            <span class="c1"># Find the relation that defines this mode</span>
            <span class="k">for</span> <span class="n">result</span><span class="p">,</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">relations</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="n">mode</span><span class="p">:</span>
                    <span class="n">terms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_expression_for_propagation</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">symbolic_expressions</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

                    <span class="k">for</span> <span class="n">dep_mode</span><span class="p">,</span> <span class="n">coeff</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">dep_mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbolic_expressions</span><span class="p">:</span>
                            <span class="c1"># Add contribution from dependency</span>
                            <span class="k">for</span> <span class="n">base_mode</span><span class="p">,</span> <span class="n">base_coeff</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbolic_expressions</span><span class="p">[</span>
                                <span class="n">dep_mode</span>
                            <span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                                <span class="k">if</span> <span class="n">base_mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbolic_expressions</span><span class="p">[</span><span class="n">mode</span><span class="p">]:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">symbolic_expressions</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="n">base_mode</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span>
                                        <span class="n">coeff</span> <span class="o">*</span> <span class="n">base_coeff</span>
                                    <span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">symbolic_expressions</span><span class="p">[</span><span class="n">mode</span><span class="p">][</span><span class="n">base_mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="n">coeff</span> <span class="o">*</span> <span class="n">base_coeff</span>
                                    <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># This should not happen with proper topological sort</span>
                            <span class="n">log</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;Dependency </span><span class="si">{</span><span class="n">dep_mode</span><span class="si">}</span><span class="s2"> not found when processing </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
                    <span class="k">break</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Built symbolic expressions for </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">symbolic_expressions</span><span class="p">)</span><span class="si">}</span><span class="s2"> modes&quot;</span>
        <span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Independent modes: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">independent_modes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_modes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure all modes referenced in relations exist.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">result</span><span class="p">,</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">relations</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mode </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2"> in relations not found&quot;</span><span class="p">)</span>

            <span class="c1"># Check all modes in expression exist</span>
            <span class="n">expr_modes</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">m</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;+-&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">expr</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s2">&quot;+-&quot;</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">expr_modes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mode </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2"> in relations not found&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_propagate_frequencies_symbolic</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">updated_freqs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Symbolic frequency propagation - O(n) complexity.</span>

<span class="sd">        Args:</span>
<span class="sd">            updated_freqs: Dictionary of mode labels to their new frequencies</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary of all mode labels to their computed frequencies</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Start with current frequencies</span>
        <span class="n">frequencies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">label</span><span class="p">:</span> <span class="n">mode</span><span class="o">.</span><span class="n">frequency</span> <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">frequencies</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">updated_freqs</span><span class="p">)</span>

        <span class="c1"># Evaluate each mode using its symbolic expression</span>
        <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">expression</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbolic_expressions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">updated_freqs</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># Already set by user</span>

            <span class="c1"># Check if all base modes are available</span>
            <span class="n">all_available</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">new_freq</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="k">for</span> <span class="n">base_mode</span><span class="p">,</span> <span class="n">coeff</span> <span class="ow">in</span> <span class="n">expression</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">frequencies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">base_mode</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">all_available</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>
                <span class="n">new_freq</span> <span class="o">+=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="n">frequencies</span><span class="p">[</span><span class="n">base_mode</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">all_available</span><span class="p">:</span>
                <span class="n">frequencies</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_freq</span>

        <span class="k">return</span> <span class="n">frequencies</span>

<div class="viewcode-block" id="ModeArray.update_frequencies"><a class="viewcode-back" href="../../api-reference/twpasolver.modes_rwa.html#twpasolver.modes_rwa.ModeArray.update_frequencies">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_frequencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_frequencies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update mode frequencies using optimized symbolic propagation.</span>

<span class="sd">        Args:</span>
<span class="sd">            new_frequencies: Dictionary mapping mode labels to new frequencies</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate input modes exist</span>
        <span class="n">unknown_modes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">new_frequencies</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">unknown_modes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown modes in frequency update: </span><span class="si">{</span><span class="n">unknown_modes</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Use symbolic propagation (much faster than iterative)</span>
        <span class="n">all_frequencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_propagate_frequencies_symbolic</span><span class="p">(</span><span class="n">new_frequencies</span><span class="p">)</span>

        <span class="c1"># Update modes with new frequencies and interpolated parameters</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">all_frequencies</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
                <span class="n">mode</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">freq</span>
                <span class="c1"># Get interpolated parameters (always returns kappa, gamma, alpha)</span>
                <span class="n">kappa</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolator</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">freq</span><span class="p">))</span>
                <span class="n">mode</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span>  <span class="c1"># type: ignore</span>
                <span class="n">mode</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">gamma</span>  <span class="c1"># type: ignore</span>
                <span class="n">mode</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">kappa</span> <span class="o">*</span> <span class="n">mode</span><span class="o">.</span><span class="n">direction</span>  <span class="c1"># type: ignore</span></div>

<div class="viewcode-block" id="ModeArray.update_base_data"><a class="viewcode-back" href="../../api-reference/twpasolver.modes_rwa.html#twpasolver.modes_rwa.ModeArray.update_base_data">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">update_base_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interpolator</span><span class="p">:</span> <span class="n">ParameterInterpolator</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the base data interpolator and refresh all mode parameters.</span>

<span class="sd">        Args:</span>
<span class="sd">            interpolator: New ParameterInterpolator instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interpolator</span> <span class="o">=</span> <span class="n">interpolator</span>

        <span class="c1"># Refresh all mode parameters with current frequencies</span>
        <span class="n">current_freqs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">label</span><span class="p">:</span> <span class="n">mode</span><span class="o">.</span><span class="n">frequency</span>
            <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">frequency</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">current_freqs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_frequencies</span><span class="p">(</span><span class="n">current_freqs</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModeArray.process_frequency_array"><a class="viewcode-back" href="../../api-reference/twpasolver.modes_rwa.html#twpasolver.modes_rwa.ModeArray.process_frequency_array">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">process_frequency_array</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">mode_label</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">frequencies</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process an array of frequencies for a single mode, propagating to all related modes.</span>

<span class="sd">        Uses symbolic expressions for optimal performance.</span>

<span class="sd">        Args:</span>
<span class="sd">            mode_label: Label of the mode to update with array of frequencies</span>
<span class="sd">            frequencies: Array of frequencies to process</span>

<span class="sd">        Returns:</span>
<span class="sd">            Dictionary with mode parameters for all related modes</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Validate mode exists</span>
        <span class="k">if</span> <span class="n">mode_label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown mode: </span><span class="si">{</span><span class="n">mode_label</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Initialize result containers</span>
        <span class="n">mode_params</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># For each mode, compute its frequency array using symbolic expressions</span>
        <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">expression</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbolic_expressions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">mode_label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">expression</span><span class="p">:</span>
                <span class="n">indep_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span>
                <span class="n">mode_params</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;freqs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">frequencies</span><span class="p">),</span> <span class="n">indep_mode</span><span class="o">.</span><span class="n">frequency</span><span class="p">),</span>
                    <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">frequencies</span><span class="p">),</span> <span class="n">indep_mode</span><span class="o">.</span><span class="n">k</span><span class="p">),</span>
                    <span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">frequencies</span><span class="p">),</span> <span class="n">indep_mode</span><span class="o">.</span><span class="n">gamma</span><span class="p">),</span>
                    <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">frequencies</span><span class="p">),</span> <span class="n">indep_mode</span><span class="o">.</span><span class="n">alpha</span><span class="p">),</span>
                <span class="p">}</span>
                <span class="k">continue</span>

            <span class="c1"># Compute frequency array for this mode</span>
            <span class="n">mode_freqs</span> <span class="o">=</span> <span class="n">frequencies</span> <span class="o">*</span> <span class="n">expression</span><span class="p">[</span><span class="n">mode_label</span><span class="p">]</span>

            <span class="c1"># Add contributions from other independent modes if they have values</span>
            <span class="k">for</span> <span class="n">base_mode</span><span class="p">,</span> <span class="n">coeff</span> <span class="ow">in</span> <span class="n">expression</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">base_mode</span> <span class="o">!=</span> <span class="n">mode_label</span>
                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">base_mode</span><span class="p">]</span><span class="o">.</span><span class="n">frequency</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="p">):</span>
                    <span class="n">mode_freqs</span> <span class="o">+=</span> <span class="n">coeff</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">base_mode</span><span class="p">]</span><span class="o">.</span><span class="n">frequency</span>

            <span class="c1"># Get direction for this mode</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span><span class="o">.</span><span class="n">direction</span>

            <span class="c1"># Get parameters for all frequencies of this mode (always returns kappa, gamma, alpha)</span>
            <span class="n">kappas</span><span class="p">,</span> <span class="n">gammas</span><span class="p">,</span> <span class="n">alphas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interpolator</span><span class="o">.</span><span class="n">get_parameters</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mode_freqs</span><span class="p">)</span>
            <span class="p">)</span>

            <span class="c1"># Apply direction to kappas</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">kappas</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="n">kappas</span> <span class="o">=</span> <span class="n">kappas</span> <span class="o">*</span> <span class="n">direction</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kappas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">kappas</span> <span class="o">*</span> <span class="n">direction</span><span class="p">])</span>

            <span class="c1"># Store parameters</span>
            <span class="n">mode_params</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;freqs&quot;</span><span class="p">:</span> <span class="n">mode_freqs</span><span class="p">,</span>
                <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="n">kappas</span><span class="p">,</span>
                <span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="n">gammas</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
                <span class="s2">&quot;alpha&quot;</span><span class="p">:</span> <span class="n">alphas</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="n">mode_params</span></div>

<div class="viewcode-block" id="ModeArray.plot_mode_relations"><a class="viewcode-back" href="../../api-reference/twpasolver.modes_rwa.html#twpasolver.modes_rwa.ModeArray.plot_mode_relations">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">plot_mode_relations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">figsize</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span>
        <span class="n">node_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3000</span><span class="p">,</span>
        <span class="n">font_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
        <span class="n">show_frequencies</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">show_directions</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">layout</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;hierarchical&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot the relationships between modes as a directed graph.</span>

<span class="sd">        Args:</span>
<span class="sd">            figsize: Figure size (width, height)</span>
<span class="sd">            node_size: Size of mode nodes</span>
<span class="sd">            font_size: Font size for labels</span>
<span class="sd">            show_frequencies: Whether to show current frequencies on nodes</span>
<span class="sd">            show_directions: Whether to show mode propagation directions</span>
<span class="sd">            layout: Graph layout algorithm (&#39;spring&#39;, &#39;circular&#39;, &#39;hierarchical&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create directed graph</span>
        <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>

        <span class="c1"># Add nodes for all modes</span>
        <span class="k">for</span> <span class="n">mode_label</span><span class="p">,</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">node_attrs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;frequency&quot;</span><span class="p">:</span> <span class="n">mode</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span>
                <span class="s2">&quot;direction&quot;</span><span class="p">:</span> <span class="n">mode</span><span class="o">.</span><span class="n">direction</span><span class="p">,</span>
                <span class="s2">&quot;is_independent&quot;</span><span class="p">:</span> <span class="n">mode_label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">independent_modes</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="n">G</span><span class="o">.</span><span class="n">add_node</span><span class="p">(</span><span class="n">mode_label</span><span class="p">,</span> <span class="o">**</span><span class="n">node_attrs</span><span class="p">)</span>

        <span class="c1"># Add edges based on relations</span>
        <span class="n">edge_labels</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">result</span><span class="p">,</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">relations</span><span class="p">:</span>
            <span class="n">terms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_expression_for_propagation</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">dep_mode</span><span class="p">,</span> <span class="n">coeff</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">coeff</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">edge_color</span> <span class="o">=</span> <span class="s2">&quot;blue&quot;</span>
                    <span class="n">edge_style</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">edge_color</span> <span class="o">=</span> <span class="s2">&quot;red&quot;</span>
                    <span class="n">edge_style</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span>

                <span class="n">G</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span>
                    <span class="n">dep_mode</span><span class="p">,</span>
                    <span class="n">result</span><span class="p">,</span>
                    <span class="n">weight</span><span class="o">=</span><span class="nb">abs</span><span class="p">(</span><span class="n">coeff</span><span class="p">),</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">edge_color</span><span class="p">,</span>
                    <span class="n">style</span><span class="o">=</span><span class="n">edge_style</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="c1"># Create edge label</span>
                <span class="n">coeff_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;+</span><span class="si">{</span><span class="n">coeff</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">coeff</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="nb">str</span><span class="p">(</span><span class="n">coeff</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">dep_mode</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span> <span class="ow">in</span> <span class="n">edge_labels</span><span class="p">:</span>
                    <span class="n">edge_labels</span><span class="p">[(</span><span class="n">dep_mode</span><span class="p">,</span> <span class="n">result</span><span class="p">)]</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;, </span><span class="si">{</span><span class="n">coeff_str</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">edge_labels</span><span class="p">[(</span><span class="n">dep_mode</span><span class="p">,</span> <span class="n">result</span><span class="p">)]</span> <span class="o">=</span> <span class="n">coeff_str</span>

        <span class="c1"># Create figure</span>
        <span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;width_ratios&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]}</span>
        <span class="p">)</span>

        <span class="c1"># Choose layout</span>
        <span class="k">if</span> <span class="n">layout</span> <span class="o">==</span> <span class="s2">&quot;hierarchical&quot;</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hierarchical_layout</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">layout</span> <span class="o">==</span> <span class="s2">&quot;circular&quot;</span><span class="p">:</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">circular_layout</span><span class="p">(</span><span class="n">G</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>  <span class="c1"># spring layout</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">spring_layout</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

        <span class="c1"># Node colors based on type</span>
        <span class="n">node_colors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">node</span><span class="p">][</span><span class="s2">&quot;is_independent&quot;</span><span class="p">]:</span>
                <span class="n">node_colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;lightgreen&quot;</span><span class="p">)</span>  <span class="c1"># Independent modes</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">node_colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;lightblue&quot;</span><span class="p">)</span>  <span class="c1"># Dependent modes</span>

        <span class="c1"># Draw nodes</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_nodes</span><span class="p">(</span>
            <span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">node_color</span><span class="o">=</span><span class="n">node_colors</span><span class="p">,</span> <span class="n">node_size</span><span class="o">=</span><span class="n">node_size</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span>
        <span class="p">)</span>

        <span class="c1"># Draw edges with different styles</span>
        <span class="n">edge_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">G</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">edges</span><span class="p">()]</span>
        <span class="n">edge_styles</span> <span class="o">=</span> <span class="p">[</span><span class="n">G</span><span class="o">.</span><span class="n">edges</span><span class="p">[</span><span class="n">edge</span><span class="p">][</span><span class="s2">&quot;style&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">edge</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">edges</span><span class="p">()]</span>

        <span class="c1"># Draw positive and negative edges separately for different styles</span>
        <span class="n">pos_edges</span> <span class="o">=</span> <span class="p">[(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;blue&quot;</span><span class="p">]</span>
        <span class="n">neg_edges</span> <span class="o">=</span> <span class="p">[(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">edges</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;color&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;red&quot;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">pos_edges</span><span class="p">:</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span>
                <span class="n">G</span><span class="p">,</span>
                <span class="n">pos</span><span class="p">,</span>
                <span class="n">edgelist</span><span class="o">=</span><span class="n">pos_edges</span><span class="p">,</span>
                <span class="n">edge_color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span>
                <span class="n">arrows</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">arrowsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">neg_edges</span><span class="p">:</span>
            <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edges</span><span class="p">(</span>
                <span class="n">G</span><span class="p">,</span>
                <span class="n">pos</span><span class="p">,</span>
                <span class="n">edgelist</span><span class="o">=</span><span class="n">neg_edges</span><span class="p">,</span>
                <span class="n">edge_color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
                <span class="n">style</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
                <span class="n">arrows</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">arrowsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Node labels</span>
        <span class="k">if</span> <span class="n">show_frequencies</span> <span class="ow">and</span> <span class="n">show_directions</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">mode_label</span><span class="p">,</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">direction_str</span> <span class="o">=</span> <span class="s2">&quot;→&quot;</span> <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;←&quot;</span>
                <span class="n">freq_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mode</span><span class="o">.</span><span class="n">frequency</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">frequency</span> <span class="k">else</span> <span class="s2">&quot;None&quot;</span>
                <span class="n">labels</span><span class="p">[</span><span class="n">mode_label</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mode_label</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">direction_str</span><span class="si">}</span><span class="se">\n</span><span class="s2">(</span><span class="si">{</span><span class="n">freq_str</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="k">elif</span> <span class="n">show_frequencies</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">mode_label</span><span class="p">,</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">freq_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mode</span><span class="o">.</span><span class="n">frequency</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">frequency</span> <span class="k">else</span> <span class="s2">&quot;None&quot;</span>
                <span class="n">labels</span><span class="p">[</span><span class="n">mode_label</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mode_label</span><span class="si">}</span><span class="se">\n</span><span class="s2">(</span><span class="si">{</span><span class="n">freq_str</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="k">elif</span> <span class="n">show_directions</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">mode_label</span><span class="p">,</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">direction_str</span> <span class="o">=</span> <span class="s2">&quot;→&quot;</span> <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;←&quot;</span>
                <span class="n">labels</span><span class="p">[</span><span class="n">mode_label</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mode_label</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">direction_str</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span><span class="n">mode</span><span class="p">:</span> <span class="n">mode</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">()}</span>

        <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_labels</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="n">font_size</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>

        <span class="c1"># Edge labels (coefficients)</span>
        <span class="n">nx</span><span class="o">.</span><span class="n">draw_networkx_edge_labels</span><span class="p">(</span>
            <span class="n">G</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">edge_labels</span><span class="p">,</span> <span class="n">font_size</span><span class="o">=</span><span class="n">font_size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span>
        <span class="p">)</span>

        <span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Mode Relationships&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>

        <span class="c1"># Legend</span>
        <span class="n">legend_elements</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightgreen&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Independent modes&quot;</span><span class="p">),</span>
            <span class="n">mpatches</span><span class="o">.</span><span class="n">Patch</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">&quot;lightblue&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Dependent modes&quot;</span><span class="p">),</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">Line2D</span><span class="p">([</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;blue&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Positive contribution&quot;</span><span class="p">),</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">Line2D</span><span class="p">(</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;red&quot;</span><span class="p">,</span>
                <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Negative contribution&quot;</span><span class="p">,</span>
            <span class="p">),</span>
        <span class="p">]</span>
        <span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="n">legend_elements</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s2">&quot;upper right&quot;</span><span class="p">)</span>

        <span class="c1"># Relations text in second subplot</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">&quot;off&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Relations&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

        <span class="n">relations_text</span> <span class="o">=</span> <span class="s2">&quot;Symbolic Expressions:</span><span class="se">\n\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">expression</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbolic_expressions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">expr_parts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">base_mode</span><span class="p">,</span> <span class="n">coeff</span> <span class="ow">in</span> <span class="n">expression</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">coeff</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">expr_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_mode</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">coeff</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">expr_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-</span><span class="si">{</span><span class="n">base_mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">expr_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">coeff</span><span class="si">}</span><span class="s2">*</span><span class="si">{</span><span class="n">base_mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">expr_str</span> <span class="o">=</span> <span class="s2">&quot; + &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">expr_parts</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; + -&quot;</span><span class="p">,</span> <span class="s2">&quot; - &quot;</span><span class="p">)</span>
            <span class="n">relations_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">expr_str</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">relations_text</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Independent: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">independent_modes</span><span class="p">))</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">ax2</span><span class="o">.</span><span class="n">text</span><span class="p">(</span>
            <span class="mf">0.05</span><span class="p">,</span>
            <span class="mf">0.95</span><span class="p">,</span>
            <span class="n">relations_text</span><span class="p">,</span>
            <span class="n">transform</span><span class="o">=</span><span class="n">ax2</span><span class="o">.</span><span class="n">transAxes</span><span class="p">,</span>
            <span class="n">fontsize</span><span class="o">=</span><span class="n">font_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
            <span class="n">verticalalignment</span><span class="o">=</span><span class="s2">&quot;top&quot;</span><span class="p">,</span>
            <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s2">&quot;round,pad=0.3&quot;</span><span class="p">,</span> <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.8</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

    <span class="k">def</span><span class="w"> </span><span class="nf">_hierarchical_layout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">G</span><span class="p">:</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create hierarchical layout with independent modes at bottom.&quot;&quot;&quot;</span>
        <span class="n">levels</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Independent modes at level 0</span>
        <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">independent_modes</span><span class="p">:</span>
            <span class="n">levels</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Assign levels based on dependencies</span>
        <span class="n">max_level</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">nx</span><span class="o">.</span><span class="n">topological_sort</span><span class="p">(</span><span class="n">G</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">levels</span><span class="p">:</span>
                <span class="c1"># Find maximum level of predecessors</span>
                <span class="n">pred_levels</span> <span class="o">=</span> <span class="p">[</span><span class="n">levels</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">pred</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">predecessors</span><span class="p">(</span><span class="n">mode</span><span class="p">)]</span>
                <span class="n">levels</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">pred_levels</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">max_level</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_level</span><span class="p">,</span> <span class="n">levels</span><span class="p">[</span><span class="n">mode</span><span class="p">])</span>

        <span class="c1"># Create positions</span>
        <span class="n">level_counts</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">level_positions</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Count nodes per level</span>
        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">levels</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">level_counts</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">pos</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">levels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">level_positions</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">level_counts</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">max_level</span> <span class="o">-</span> <span class="n">level</span>  <span class="c1"># Flip so independent modes are at bottom</span>
            <span class="n">pos</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">level_positions</span><span class="p">[</span><span class="n">level</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">pos</span>

<div class="viewcode-block" id="ModeArray.get_mode"><a class="viewcode-back" href="../../api-reference/twpasolver.modes_rwa.html#twpasolver.modes_rwa.ModeArray.get_mode">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">label</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mode</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get mode by label.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="p">[</span><span class="n">label</span><span class="p">]</span></div>

<div class="viewcode-block" id="ModeArray.get_rwa_terms"><a class="viewcode-back" href="../../api-reference/twpasolver.modes_rwa.html#twpasolver.modes_rwa.ModeArray.get_rwa_terms">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_rwa_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">power</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get RWA terms for the specified mixing order with caching.</span>

<span class="sd">        Args:</span>
<span class="sd">            power: Order of the interaction (2 for 3WM, 3 for 4WM)</span>

<span class="sd">        Returns:</span>
<span class="sd">            List of RWA terms</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">power</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rwa_terms_3wm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rwa_terms_3wm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">find_rwa_terms</span><span class="p">(</span><span class="n">power</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rwa_terms_3wm</span>
        <span class="k">elif</span> <span class="n">power</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rwa_terms_4wm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rwa_terms_4wm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">find_rwa_terms</span><span class="p">(</span><span class="n">power</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rwa_terms_4wm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># For other powers, go directly to the analyzer without caching</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyzer</span><span class="o">.</span><span class="n">find_rwa_terms</span><span class="p">(</span><span class="n">power</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModeArray.print_modes"><a class="viewcode-back" href="../../api-reference/twpasolver.modes_rwa.html#twpasolver.modes_rwa.ModeArray.print_modes">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">print_modes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print current state of all modes.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">modes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">independence</span> <span class="o">=</span> <span class="s2">&quot; (independent)&quot;</span> <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">independent_modes</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">label</span><span class="si">}{</span><span class="n">independence</span><span class="si">}</span><span class="s2">:&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Frequency: </span><span class="si">{</span><span class="n">mode</span><span class="o">.</span><span class="n">frequency</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Direction: </span><span class="si">{</span><span class="n">mode</span><span class="o">.</span><span class="n">direction</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  k: </span><span class="si">{</span><span class="n">mode</span><span class="o">.</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  gamma: </span><span class="si">{</span><span class="n">mode</span><span class="o">.</span><span class="n">gamma</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  alpha: </span><span class="si">{</span><span class="n">mode</span><span class="o">.</span><span class="n">alpha</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">()</span></div>

<div class="viewcode-block" id="ModeArray.print_symbolic_expressions"><a class="viewcode-back" href="../../api-reference/twpasolver.modes_rwa.html#twpasolver.modes_rwa.ModeArray.print_symbolic_expressions">[docs]</a>    <span class="k">def</span><span class="w"> </span><span class="nf">print_symbolic_expressions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Print the symbolic expressions for all modes.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Symbolic Expressions:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">50</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">mode</span><span class="p">,</span> <span class="n">expression</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">symbolic_expressions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">expr_parts</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">base_mode</span><span class="p">,</span> <span class="n">coeff</span> <span class="ow">in</span> <span class="n">expression</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">coeff</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">expr_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_mode</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">coeff</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">expr_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;-</span><span class="si">{</span><span class="n">base_mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">expr_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">coeff</span><span class="si">}</span><span class="s2">*</span><span class="si">{</span><span class="n">base_mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">expr_str</span> <span class="o">=</span> <span class="s2">&quot; + &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">expr_parts</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; + -&quot;</span><span class="p">,</span> <span class="s2">&quot; - &quot;</span><span class="p">)</span>
            <span class="n">independence</span> <span class="o">=</span> <span class="s2">&quot; (independent)&quot;</span> <span class="k">if</span> <span class="n">mode</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">independent_modes</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">mode</span><span class="si">}{</span><span class="n">independence</span><span class="si">}</span><span class="s2"> = </span><span class="si">{</span><span class="n">expr_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ModeArrayFactory"><a class="viewcode-back" href="../../api-reference/twpasolver.modes_rwa.html#twpasolver.modes_rwa.ModeArrayFactory">[docs]</a><span class="k">class</span><span class="w"> </span><span class="nc">ModeArrayFactory</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Factory for creating standard ModeArray configurations.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="ModeArrayFactory.create_basic_3wm"><a class="viewcode-back" href="../../api-reference/twpasolver.modes_rwa.html#twpasolver.modes_rwa.ModeArrayFactory.create_basic_3wm">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_basic_3wm</span><span class="p">(</span>
        <span class="n">base_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">forward_modes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ModeArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a basic 3WM ModeArray with pump, signal, and idler modes.</span>

<span class="sd">        Args:</span>
<span class="sd">            base_data: Dictionary containing &#39;freqs&#39;, &#39;k&#39;, &#39;gammas&#39;, and &#39;alpha&#39; arrays</span>
<span class="sd">            forward_modes: Whether to create forward (True) or backward (False) propagating modes</span>

<span class="sd">        Returns:</span>
<span class="sd">            ModeArray: Configured for basic 3WM operation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extract required arrays from base_data</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="n">base_data</span><span class="p">[</span><span class="s2">&quot;freqs&quot;</span><span class="p">]</span>
        <span class="n">kappas</span> <span class="o">=</span> <span class="n">base_data</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">]</span>
        <span class="n">gammas</span> <span class="o">=</span> <span class="n">base_data</span><span class="p">[</span><span class="s2">&quot;gammas&quot;</span><span class="p">]</span>
        <span class="n">alphas</span> <span class="o">=</span> <span class="n">base_data</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span>

        <span class="c1"># Create interpolator</span>
        <span class="n">interpolator</span> <span class="o">=</span> <span class="n">ParameterInterpolator</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="n">kappas</span><span class="p">,</span> <span class="n">gammas</span><span class="p">,</span> <span class="n">alphas</span><span class="p">)</span>

        <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">forward_modes</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">modes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Mode</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">),</span>
            <span class="n">Mode</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">),</span>
            <span class="n">Mode</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="n">relations</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;p-s&quot;</span><span class="p">]]</span>  <span class="c1"># Idler is pump minus signal</span>

        <span class="k">return</span> <span class="n">ModeArray</span><span class="p">(</span><span class="n">modes</span><span class="p">,</span> <span class="n">relations</span><span class="p">,</span> <span class="n">interpolator</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModeArrayFactory.create_extended_3wm"><a class="viewcode-back" href="../../api-reference/twpasolver.modes_rwa.html#twpasolver.modes_rwa.ModeArrayFactory.create_extended_3wm">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_extended_3wm</span><span class="p">(</span>
        <span class="n">base_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">n_pump_harmonics</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">n_frequency_conversion</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">n_signal_harmonics</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">n_sidebands</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">forward_modes</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ModeArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an extended 3WM ModeArray with pump harmonics and conversion terms.</span>

<span class="sd">        Args:</span>
<span class="sd">            base_data: Dictionary containing &#39;freqs&#39;, &#39;k&#39;, &#39;gammas&#39;, and &#39;alpha&#39; arrays</span>
<span class="sd">            n_pump_harmonics: Number of pump harmonics to include</span>
<span class="sd">            n_frequency_conversion: Number of frequency conversion terms</span>
<span class="sd">            n_signal_harmonics: Number of signal and idler harmonics</span>
<span class="sd">            forward_modes: Whether to create forward (True) or backward (False) propagating modes</span>

<span class="sd">        Returns:</span>
<span class="sd">            ModeArray: Configured for extended 3WM operation with harmonics</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extract required arrays from base_data</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="n">base_data</span><span class="p">[</span><span class="s2">&quot;freqs&quot;</span><span class="p">]</span>
        <span class="n">kappas</span> <span class="o">=</span> <span class="n">base_data</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">]</span>
        <span class="n">gammas</span> <span class="o">=</span> <span class="n">base_data</span><span class="p">[</span><span class="s2">&quot;gammas&quot;</span><span class="p">]</span>
        <span class="n">alphas</span> <span class="o">=</span> <span class="n">base_data</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span>

        <span class="c1"># Create interpolator</span>
        <span class="n">interpolator</span> <span class="o">=</span> <span class="n">ParameterInterpolator</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="n">kappas</span><span class="p">,</span> <span class="n">gammas</span><span class="p">,</span> <span class="n">alphas</span><span class="p">)</span>

        <span class="n">direction</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">forward_modes</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># Create basic modes</span>
        <span class="n">modes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Mode</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">),</span>
            <span class="n">Mode</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">),</span>
            <span class="n">Mode</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">),</span>
        <span class="p">]</span>

        <span class="c1"># Basic relation</span>
        <span class="n">relations</span> <span class="o">=</span> <span class="p">[[</span><span class="s2">&quot;i&quot;</span><span class="p">,</span> <span class="s2">&quot;p-s&quot;</span><span class="p">]]</span>  <span class="c1"># Idler is pump minus signal</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_frequency_conversion</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">modes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mode</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;ps&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">))</span>  <span class="c1"># p+s</span>
                <span class="n">modes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mode</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s2">&quot;pi&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">))</span>  <span class="c1"># p+i</span>
                <span class="n">relations</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;ps&quot;</span><span class="p">,</span> <span class="s2">&quot;p+s&quot;</span><span class="p">])</span>
                <span class="n">relations</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="s2">&quot;pi&quot;</span><span class="p">,</span> <span class="s2">&quot;p+i&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">modes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mode</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;p</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">))</span>  <span class="c1"># p+s</span>
                <span class="n">modes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mode</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;p</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">i&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">))</span>  <span class="c1"># p+i</span>
                <span class="n">relations</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;p</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span> <span class="s2">&quot;p+&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;p+s&quot;</span><span class="p">])</span>
                <span class="n">relations</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;p</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">i&quot;</span><span class="p">,</span> <span class="s2">&quot;p+&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;p+i&quot;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_pump_harmonics</span> <span class="o">+</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">modes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mode</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;p</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">))</span>
            <span class="n">relations</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;p</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;p+&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;p&quot;</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_signal_harmonics</span> <span class="o">+</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">modes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mode</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;s</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">))</span>
            <span class="n">relations</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;s</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;s+&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;s&quot;</span><span class="p">])</span>
            <span class="n">modes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Mode</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;i</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">))</span>
            <span class="n">relations</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="sa">f</span><span class="s2">&quot;i</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;i+&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;i&quot;</span><span class="p">])</span>

        <span class="c1"># for n in range(2, n_sidebands + 2):</span>
        <span class="c1">#     modes.append(Mode(label=f&quot;s{n}p&quot;, direction=direction))</span>
        <span class="c1">#     modes.append(Mode(label=f&quot;i{n}p&quot;, direction=direction))</span>
        <span class="c1">#     relations.append([f&quot;s{n}p&quot;, &quot;s+s-p&quot;])</span>
        <span class="c1">#     relations.append([f&quot;i{n}p&quot;, &quot;i+i-p&quot;])</span>

        <span class="k">return</span> <span class="n">ModeArray</span><span class="p">(</span><span class="n">modes</span><span class="p">,</span> <span class="n">relations</span><span class="p">,</span> <span class="n">interpolator</span><span class="p">)</span></div>

<div class="viewcode-block" id="ModeArrayFactory.create_custom"><a class="viewcode-back" href="../../api-reference/twpasolver.modes_rwa.html#twpasolver.modes_rwa.ModeArrayFactory.create_custom">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_custom</span><span class="p">(</span>
        <span class="n">base_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
        <span class="n">mode_labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">mode_directions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">relations</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ModeArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a custom ModeArray with user-defined modes and relations.</span>

<span class="sd">        Args:</span>
<span class="sd">            base_data: Dictionary containing &#39;freqs&#39;, &#39;k&#39;, &#39;gammas&#39;, and &#39;alpha&#39; arrays</span>
<span class="sd">            mode_labels: List of mode labels</span>
<span class="sd">            mode_directions: List of mode directions (1 for forward, -1 for backward)</span>
<span class="sd">            relations: List of relations between modes</span>

<span class="sd">        Returns:</span>
<span class="sd">            ModeArray: Custom configured ModeArray</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mode_labels</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mode_directions</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;mode_labels and mode_directions must have the same length&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Extract required arrays from base_data</span>
        <span class="n">freqs</span> <span class="o">=</span> <span class="n">base_data</span><span class="p">[</span><span class="s2">&quot;freqs&quot;</span><span class="p">]</span>
        <span class="n">kappas</span> <span class="o">=</span> <span class="n">base_data</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">]</span>
        <span class="n">gammas</span> <span class="o">=</span> <span class="n">base_data</span><span class="p">[</span><span class="s2">&quot;gammas&quot;</span><span class="p">]</span>
        <span class="n">alphas</span> <span class="o">=</span> <span class="n">base_data</span><span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">]</span>

        <span class="c1"># Create interpolator</span>
        <span class="n">interpolator</span> <span class="o">=</span> <span class="n">ParameterInterpolator</span><span class="p">(</span><span class="n">freqs</span><span class="p">,</span> <span class="n">kappas</span><span class="p">,</span> <span class="n">gammas</span><span class="p">,</span> <span class="n">alphas</span><span class="p">)</span>

        <span class="n">modes</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Mode</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">direction</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mode_labels</span><span class="p">,</span> <span class="n">mode_directions</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">ModeArray</span><span class="p">(</span><span class="n">modes</span><span class="p">,</span> <span class="n">relations</span><span class="p">,</span> <span class="n">interpolator</span><span class="p">)</span></div></div>
</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, twpalab
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/twpalab/twpasolver" aria-label="GitHub">
                    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                    </svg>
                </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/scripts/furo.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    </body>
</html>